---
title: aomenc
sidebar_position: 4
keywords: [AV1, 编码, 视频编码, AOM AV1]
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# aomenc

[aomenc](https://aomedia.googlesource.com/aom/)，又称AOM-AV1或简称**libaom**，是由AOMedia开发的基于C和汇编语言编写的AV1命令行编码器，同时也是AV1标准的参考编码器实现。

## FFmpeg集成

aomenc可通过FFmpeg的``libaom-av1``编解码器调用，执行``ffmpeg -h encoder=libaom-av1``可查看支持情况。非FFmpeg标准的aomenc参数需通过``-aom-params``传递。

## 支持的色彩空间

aomenc支持以下色彩空间格式：

| 格式            | 色度采样       | 支持位深        |
|-----------------|:-------------:|----------------|
| YUV420P         | 4:2:0         | 8-bit          |
| YUV422P         | 4:2:2         | 8-bit          |
| YUV444P         | 4:4:4         | 8-bit          |
| GBRP            | -             | 8-bit          |
| GRAY8           | -             | 8-bit          |
| YUV420P10LE     | 4:2:0         | 10-bit         |
| YUV422P10LE     | 4:2:2         | 10-bit         |
| YUV444P10LE     | 4:4:4         | 10-bit         |
| GBRP10LE        | -             | 10-bit         |
| GRAY10LE        | -             | 10-bit         |
| YUV420P12LE     | 4:2:0         | 12-bit         |
| YUV422P12LE     | 4:2:2         | 12-bit         |
| YUV444P12LE     | 4:4:4         | 12-bit         |
| GBRP12LE        | -             | 12-bit         |
| GRAY12LE        | -             | 12-bit         |


## 安装指南

<Tabs>
    <TabItem value="unixlike" label="Linux & macOS" default>
        1. 克隆主代码库：
        ```bash title="克隆代码库"
        git clone https://aomedia.googlesource.com/aom
        cd aom && mkdir aom_build && cd aom_build
        ```

        2. 配置编译参数（以下参数确保生成高性能编码器）：
        ```bash title="CMake配置"
        cmake .. -DBUILD_SHARED_LIBS=0 -DENABLE_DOCS=0 -DCONFIG_TUNE_BUTTERAUGLI=0 -DCONFIG_TUNE_VMAF=0 -DCONFIG_AV1_DECODER=0 -DENABLE_TESTS=0 -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-flto -O3 -march=native" -DCMAKE_C_FLAGS="-flto -O3 -march=native -pipe -fno-plt" -DCMAKE_LD_FLAGS="-flto -O3 -march=native"
        ```

        3. 开始编译：
        ```bash title="编译"
        make -j$(nproc)
        ```

        4. 安装到系统（可能需要管理员权限）：
        ```bash title="安装"
        make install
        ```
    </TabItem>
    <TabItem value="wind" label="Windows">
        **MSYS2**是Windows平台最佳编译环境

        0. 从[MSYS2官网](https://www.msys2.org/)下载安装MSYS2

        1. 启动UCRT64终端并安装依赖：
        ```bash
        pacman -S cmake git perl yasm nasm python3 doxygen mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake base-devel
        ```

        2. 克隆主代码库：
        ```bash title="克隆代码库"
        git clone https://aomedia.googlesource.com/aom
        cd aom && mkdir aom_build && cd aom_build
        ```

        3. 配置编译参数：
        ```bash title="CMake配置"
        cmake .. -DBUILD_SHARED_LIBS=0 -DENABLE_DOCS=0 -DCONFIG_TUNE_BUTTERAUGLI=0 -DCONFIG_TUNE_VMAF=0 -DCONFIG_AV1_DECODER=0 -DENABLE_TESTS=0 -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-flto -O3 -march=native" -DCMAKE_C_FLAGS="-flto -O3 -march=native -pipe -fno-plt" -DCMAKE_LD_FLAGS="-flto -O3 -march=native"
        ```

        4. 开始编译：
        ```bash title="编译"
        make -j$(nproc)
        ```

        编译生成的可执行文件位于MSYS2安装目录（通常为`C:`盘）下的`aom`文件夹内，"Debug"文件夹存放最终生成文件。
    </TabItem>
</Tabs>

:::warning 关于原生优化二进制文件
除非共享对象具有完全相同的CPU架构，否则不要分发使用原生CPU优化编译的二进制文件，这可能导致编码异常。
:::

## 使用指南

### AV1编码

:::note 关于二次编码
aomenc的设计机制要求必须使用二次编码才能充分发挥其编码效率，包括更好的码率控制和编码特性。
:::

```bash title="Y4M输入+CQ22+单次编码+IVF输出"
aomenc --end-usage=q --cq-level=32 --bit-depth=10 --passes=1 --ivf -o output.ivf input.y4m
```

```bash title="FFmpeg管道输入"
ffmpeg -v error -i input.mkv -f yuv4mpegpipe -strict -1 - | aomenc - --end-usage=q --cq-level=32 --bit-depth=10 --passes=1 --ivf -o output.ivf
```

```bash title="FFmpeg管道+二次编码（第一遍）"
ffmpeg -v error -i input.mkv -f yuv4mpegpipe -strict -1 - | aomenc - --end-usage=q --cq-level=32 --bit-depth=10 --passes=2 --pass=1 --fpf-log=aom-pass.log  --ivf -o output.ivf
```
```bash title="FFmpeg管道+二次编码（第二遍）"
ffmpeg -v error -i input.mkv -f yuv4mpegpipe -strict -1 - | aomenc - --end-usage=q --cq-level=32 --bit-depth=10 --passes=2 --pass=2 --fpf-log=aom-pass.log  --ivf -o output.ivf
```

### AVIF图像编码

通过avifenc调用aomenc是目前最理想的AVIF编码方案，因为SVT-AV1仅支持4:2:0色度采样，rav1e编码速度不足，而libaom团队在帧内编码方面投入了更多优化。典型命令示例：

`avifenc -c aom -s 4 -j 8 -d 10 -y 444 --min 1 --max 63 -a end-usage=q -a cq-level=16 -a tune=ssim [输入文件] output.avif`

参数说明：

- `-c aom` 指定编码器
- `-s 4` 速度预设，4及以下能获得最佳压缩质量
- `-j 8` 线程数，超过12可能适得其反
- `-d 10` 推荐10bit深度提升编码效率
- `-y 444` 4:4:4色度采样通常压缩率更高
- `cq-level=16` 质量参数（需通过`-a`传递）
- `tune=ssim` 率失真优化模式

## 参数推荐

aomenc原生多线程能力较弱，建议配合[Av1an](/docs/utilities/av1an)工具实现并行编码。以下参数针对Av1an和[aom-av1-lavish](./aom-av1-lavish.mdx)优化：

`--bit-depth=10 --cpu-used=4 --end-usage=q --cq-level=24 --threads=2 --tile-columns=0 --tile-rows=0 --lag-in-frames=64 --tune=ssim --enable-keyframe-filtering=1 --disable-kf --kf-max-dist=9999 --enable-qm=1 --deltaq-mode=0 --aq-mode=0 --enable-fwd-kf=0 --arnr-strength=1 --sb-size=dynamic --enable-dnl-denoising=0 --denoise-noise-level=8`

参数解析：

- `--bit-depth=10` 10bit编码可减小体积并减少色带
- `--cpu-used=4` 预设等级（0-9），4为最佳平衡点
- `--cq-level=24` 类CRF质量控制
- `--tile-columns=0` 分块编码设置（见下图黄线）

<picture>
    <source srcset="https://raw.githubusercontent.com/av1-community-contributors/images/main/tiling_av1.avif?token=GHSAT0AAAAAACEZPDXIZARY5MGSTJW4SI22ZHY636A" type="image/avif" />
    <img src="https://autumn.revolt.chat/attachments/HwhZjoDsdzLZsJM2mjzX7lEDmJn1xcYNdrQqmOxPYW/tiling_av1.jpeg" alt="分块编码示意图" loading="lazy" />
</picture>

:::note 分块策略
1080p及以下分辨率不建议分块，1440p建议`tile-columns=1`，2160p建议`tile-columns=2 --tile-rows=1`

可使用[AV1编码计算器](https://autocompressor.net/tools/av1-calculator)或[本地分块计算工具](https://github.com/gianni-rosato/av1-tile-calc)
:::

- `--arnr-strength=1` 降噪强度参数（动画推荐1，实拍推荐4）
- `--denoise-noise-level=8` 胶片颗粒合成（值>12会产生明显颗粒图案）

:::info
也可通过`--film-grain-table`使用光子噪声表，Av1an中简化为`--photon-noise=X`参数
:::

## 社区改进版

官方aomenc存在默认参数不佳、过度依赖[PSNR](../metrics/PSNR.mdx)指标等问题，社区衍生版本包括：

- [aom-av1-psy](https://github.com/BlueSwordM/aom-av1-psy) *2023年1月停止维护*
- [aom-av1-lavish](./aom-av1-lavish.mdx) *2024年6月停止维护*
- [aom-psy101](./aom-psy101.mdx)
- [aom-av1ador](https://github.com/porcino/aom-av1ador)

这些改进版修正了原始实现的缺陷，并引入了更精细的参数调节体系。